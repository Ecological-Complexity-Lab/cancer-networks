---
title: "Cross cancer netweorks analysis"
output: html_notebook
---

Here I will use ecologycal network analysis tools to loot into the difference between the networks of the different cancer tissues

the first test is to look at the "species turn-over" and "species similatiry" between the cancer networks. if there's anything interesting then we will move forward with this to normalize using bootstraps

# convert correlations to binary
read the networks and set 0/1 for the correlations

```{r convert_to_binari_matrix_functions}
library("readxl")

#calc bonf
Calc_bonf <- function(alfa, nrows, ncols) {
  p <- alfa/(nrows*ncols)
  print(p)
  return(p)
}

filter_single_cancer_network <- function(cancer_name, r_file, p_file) {
  # read sheets
  #r_vals <- read_excel(r_file, sheet = cancer_name)
  p_vals <- read_excel(p_file, sheet = cancer_name)
  p_vals <- data.frame(p_vals, row.names = 1)
  
  # bonf
  p_val_cutoff <- Calc_bonf(0.05, nrow(p_vals), ncol(p_vals))
  
  # create the output df from the p value matrix
  m <- matrix(-1, nrow = nrow(p_vals), ncol = ncol(p_vals))
  rownames(m) <- row.names(p_vals)
  colnames(m) <- colnames(p_vals)
  r_new <- data.frame(m)
  
  # run over rowsXcols to mark 0/1 if the correlation is there
  for (row in row.names(p_vals)) {
      for (col in colnames(p_vals)) {
        
        # mark 0 or 1 according to the P-value
        if (p_vals[row, col] < p_val_cutoff){
          r_new[row, col] <- 1
        } else{
          r_new[row, col] <- 0
        }
        # TODO so R has no relevance? if we have a r = 0.1 is that still ok?
        # TODO also ENSG00000214736 has no data, just ignoring it for now. is it ok?
    }
  }
  
  return(r_new)
}

```

run the convertion

```{r run_the_convertion}
library("writexl")

folder_path <- "C:/Users/Geut/Desktop/Lab Analysis/cross cancer analysis/"
r_vals_excl_file <- paste(folder_path, "raw data/results/ r_values__rand_288_samples.xlsx", sep = "")
p_vals_excl_file <- paste(folder_path, "raw data/results/ p_values__rand_288_samples.xlsx", sep = "")
output_path <- paste(folder_path, "raw data/results/binari_networks/", "binari_288_samples.xlsx", sep = "")

# do the convert for every cancer
cancer_names <- excel_sheets(p_vals_excl_file)


networks <- list()
for (name in cancer_names) {
  x <- filter_single_cancer_network(name, r_vals_excl_file, p_vals_excl_file)
  x <- cbind(" "=rownames(x), x)
  
  networks[[name]] <- x
}

# save all in an excel
write_xlsx(networks, output_path)
```

# beta-diversity analysis

to run the beta link analysis - you can either convert the networks from correlation tables: \^ or read them from an excel file: v

```{r read_file_to_run_betalink}
library("readxl")

file_name <- "binari_validated_corrs.xlsx"
folder_path <- "C:/Users/Geut/Desktop/Lab Analysis/cross cancer analysis/HPC/results 27.5.21/"
input <- paste(folder_path, file_name, sep="")

# do the convert for every cancer
sheet_names <- excel_sheets(input)

networks <- list()
for (name in sheet_names) {
  x <- as.data.frame(read_excel(input, sheet = name, col_names = TRUE))
  x2 <- x[,-1]
  rownames(x2) <- x[,1]
  networks[[name]] <- x2
}

```

run the betalink analysis

```{r run_betalink_on_binari_matrix}
library(betalink)

pairwise_path <- paste(folder_path, "cross_cancer_B01_31.5.21.xlsx", sep = "")

# turn matrixes to igraphs so to compare them using betalink
graph_list <- prepare_networks(networks, directed = FALSE)

# run the comparison analysis on the data uses B10 algorithem
pairwise_dist <- network_betadiversity(graph_list, complete = FALSE,  bf = betalink::B01)

# print/save the results
write_xlsx(pairwise_dist, pairwise_path)

```

betalink package main elements:
network_betadiversity - Components of beta-diversity for a list of networks network_betaplot - Plot a network with species and interactions highlighted prepare_networks - Prepare networks


# relative degree analysing

Create a relative degree table 

```{r relative_degree_per_cancer}

genes_path <- "C:/Users/Geut/Desktop/Lab Analysis/cross cancer analysis/HPC/mito_chap_networks/"


# get the list of proteins ENSID as rownames, SYBOL as first row
prots_meta <- read.table(paste(genes_path, "Mito_genes.tab", sep=""), 
                         sep="\t", header=TRUE, stringsAsFactors=FALSE,
                         quote="", fill=FALSE)
chaps_meta <- read.table(paste(genes_path, "Mito_ch_genes.tab", sep=""), 
                         sep="\t", header=TRUE, stringsAsFactors=FALSE,
                         quote="", fill=FALSE)
prots_meta <- prots_meta[!prots_meta$ENSID %in% chaps_meta$ENSID, ]
degree_table <- prots_meta[, 3:4]

# go over the cancers
for (i in 1:length(networks)) {
  netname <- names(networks)[i]
  net <- networks[[i]]
  
  # go over the proteins
  prot_degrees <- c()
  for (prot in 1:nrow(prots_meta)) {
    ens <- prots_meta[prot, "ENSID"]
    # calc relative degree
    
    prot_degrees[ens] <- sum(net[, ens])/15
  }
  
  # put each cancer in a new column
  curr_cancer_degrees <- data.frame(prot_degrees)
  new_col_names <- c(colnames(degree_table), netname)
  print(new_col_names)
  
  degree_table <- merge(degree_table,curr_cancer_degrees,
                        by.x="ENSID", by.y=0,all.x=TRUE)
  colnames(degree_table) <- new_col_names
}
View(degree_table)

# save the table to a file
write.csv(degree_table, "relative_degree.csv", row.names = TRUE)

```

sum the cancer networks - a union of the networks 
```{r sum_cancer_networks}

sum_table <- networks[[1]]
sum_table[,] <- 0 

for (i in 1:length(networks)) {
  net <- networks[[i]]
  sum_table <- sum_table + net
}

write.csv(sum_table, "corr_count.csv", row.names = TRUE)
```

relative degree for cancer union 
```{r relative_degree_for_union}
sum_table

# go over the proteins
union_degrees <- c()
  for (prot in 1:nrow(prots_meta)) {
    ens <- prots_meta[prot, "ENSID"]
    # calc relative degree
    
    union_degrees[ens] <- sum(sum_table[, ens])/(15*12)
  }
union_degrees <- data.frame(union_degrees)
View(union_degrees)


```

# visualize data

make a heat map for prots degree (+union) and one for sum table 

```{r make_heatmaps}
library(pheatmap)

pdf("union_corrs_heatmaps.pdf")

mat <- as.matrix(sum_table)

pheatmap(mat, cutree_rows = 2, show_colnames = FALSE, 
         clustering_method = "ward.D", 
         clustering_distance_rows = "manhattan", main = "Cancer union network")

dev.off()



pdf("relative_degree_heatmaps.pdf")

temp <- degree_table[,-2]
row.names(temp) <- temp[,1]


# add a new col that is the relative degree for the cancer union
newcolnames <- c(colnames(temp), "Cancer Union")
all_degree_table <- merge(degree_table[, -2], union_degrees,
                      by.x="ENSID", by.y=0,all.x=TRUE)
colnames(all_degree_table) <- newcolnames



mat2 <- as.matrix(all_degree_table[,-1])

pheatmap(mat2, cutree_cols = 2, show_rownames = FALSE,
         clustering_method = "ward.D", 
         clustering_distance_rows = "manhattan", main = "Protein relative degree")

dev.off()

# save the table to a file
write.csv(all_degree_table, "relative_degree_with_union.csv")

```


TODOS:
*look for more cancers
*get union values distribution
-get a "flat union" table -V
-calc the participation coefficiant -V
 - find its distribution - cancer perticipation distribution - V
-remove 0's -V
-find different color for 0's in the heatmaps
-infomap the relative degree, not including the cancer union
-add annotation for cyto-prots - "howw?" ID RATHER NOTT


```{r show_distributions}

hist(mat, breaks = -1:12, main = "distribution of cancer union values") # cancer union values
hist(mat2, main = "distribution of relative degree values") # relative degree 
# turn the relative degree to binari
the_all_degree_table <- all_degree_table
row.names(the_all_degree_table) <- all_degree_table[,1]

binari <- the_all_degree_table[,-1]
binari[binari > 0] <-  1

# sum the rows
participation_coefficiant <- rowSums(binari[,1:12], na.rm = FALSE, dims = 1)
# hist the distribution of thr sums
hist(participation_coefficiant, breaks = -1:12,
     main = "distribution of participation coefficiant values")

write.csv(as.data.frame(participation_coefficiant), file = "perticipation_coeff.csv")

```

get the list of chaperons that didn't have an interaction in ANY cancer with 
any chaperon

```{r list_type_1_proteins}

non_perticipents <- participation_coefficiant[participation_coefficiant==0]
participation_coefficiant[participation_coefficiant==1]

# save the list of proteins with zero degrees


```

```{r heatmap_without_type_1_proteins}
library(pheatmap)

all_names <- colnames(sum_table)
zero_names <- names(non_perticipents)

no_zero <- all_names[!all_names %in% zero_names]

length(zero_names)
length(no_zero)
length(all_names)

mat3 <- sum_table[,no_zero]

pheatmap(mat3, cutree_rows = 2, show_colnames = FALSE, 
         clustering_method = "ward.D", 
         clustering_distance_rows = "manhattan", main = "Cancer union network (no type1 proteins)")
```
list of proteins that have zero
 [1] "ENSG00000161281" "ENSG00000198899" "ENSG00000238205" "ENSG00000123453" "ENSG00000163114"
 [6] "ENSG00000214736" "ENSG00000198763" "ENSG00000117009" "ENSG00000198727" "ENSG00000228253"
[11] "ENSG00000166118" "ENSG00000181867" "ENSG00000175567" "ENSG00000182712" "ENSG00000140459"
[16] "ENSG00000186081" "ENSG00000166920" "ENSG00000212907" "ENSG00000019186" "ENSG00000169169"
[21] "ENSG00000179142" "ENSG00000133878" "ENSG00000198695" "ENSG00000165507"

```{r zero_different_color_heatmap}
   #V1 is random between -2 and 3 
   #V2 is equal to 1
   #V3 is random between 0 and 3

library(pheatmap)
bk1 <- c(seq(-2,0.9,by=0.1),-0.001)
bk2 <- c(0.001,seq(0.1,3,by=0.1))
bk <- c(bk1,bk2)  #combine the break limits for purpose of graphing

my_palette <- c(colorRampPalette(colors = c("darkblue", "lightblue"))(n = length(bk1)-1),
              "gray38", "gray38",
              c(colorRampPalette(colors = c("darkred", "tomato1"))(n = length(bk2)-1)))

pheatmap(mat3, color = my_palette, breaks = bk, scale = "none", 
             cluster_rows = F, cluster_cols = F, margin = c(5,5))

# TODO find how to make this work

```

